#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================

path="/"
random_key=$(ynh_string_random --length=64)
ynh_app_setting_set --key=random_key --value="$random_key"
signing_salt=$(ynh_string_random --length=8)
ynh_app_setting_set --key=signing_salt --value="$signing_salt"
admin_email=$(ynh_user_get_info --username="$admin" --key="mail")
ynh_app_setting_set --key=admin_email --value="$admin_email"

## Bypass package_checker name not compatible with pleroma
if ynh_in_ci_tests; then
    admin="test"
fi

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Setting up source files..."

ynh_setup_source --dest_dir="$install_dir/live"

chown -R "$app:www-data" "$install_dir"

#=================================================
# UPDATE THE POSTGRESQL DATABASE
#=================================================
ynh_script_progression "Configuring the PostgreSQL database..."

ynh_psql_db_shell <<< "CREATE EXTENSION IF NOT EXISTS unaccent;"

ynh_psql_db_shell <<< "CREATE EXTENSION IF NOT EXISTS pg_trgm;"

ynh_psql_db_shell <<< "CREATE EXTENSION IF NOT EXISTS citext;"

ynh_psql_db_shell <<< "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"

#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Adding system configurations related to $app..."

if [ "$cache" -eq 1 ]; then
    ynh_config_add --template="cache.conf" --destination="/etc/nginx/conf.d/$app-cache.conf"
    cat ../conf/media.conf >> ../conf/nginx.conf
fi
# Create a dedicated NGINX config
ynh_config_add_nginx

# Create a dedicated systemd config
ynh_config_add_systemd
yunohost service add "$app" --description="$app daemon for Pleroma"

#=================================================
# MAKE SETUP
#=================================================
ynh_script_progression "Making setup..."

config="/etc/$app/config.exs"
mkdir -p "/etc/$app"
chown "$app:$app" "/etc/$app"

# Generate instance
ynh_hide_warnings ynh_exec_as_app -i \
"$install_dir/live/bin/pleroma_ctl" instance gen \
    --force \
    --output "$config" \
    --output-psql /tmp/setup_db.psql \
    --domain "$domain" \
    --instance-name "$instance_name" \
    --admin-email "$admin_email" \
    --notify-email "$admin_email" \
    --dbhost localhost \
    --dbname "$db_name" \
    --dbuser "$db_user" \
    --dbpass "$db_pwd" \
    --rum N \
    --indexable Y \
    --db-configurable Y \
    --uploads-dir "$data_dir/uploads" \
    --static-dir "$data_dir/static" \
    --listen-ip 127.0.0.1 \
    --listen-port "$port" \
    --strip-uploads-location Y \
    --read-uploads-description Y \
    --anonymize-uploads Y \
    --dedupe-uploads Y

cat "../conf/ldap.exs" >> "$config"

ynh_replace --file="$config" \
    --match="config :pleroma, configurable_from_database: false" \
    --replace="config :pleroma, configurable_from_database: true"

ynh_replace --file="$config" \
    --match="registrations_open: true" \
    --replace="registrations_open: $(boolstr "$registration")"

ynh_hide_warnings ynh_exec_as_app -i "$install_dir/live/bin/pleroma_ctl" migrate
ynh_systemctl --service="$app" --action="start" --log_path=systemd --wait_until="Access Pleroma.Web.Endpoint"

# Add user
ynh_hide_warnings ynh_exec_as_app -i "$install_dir/live/bin/pleroma_ctl" user new "$admin" "$admin_email" --password "$password" --moderator --admin -y
ynh_systemctl --service="$app" --action="stop" --log_path=systemd

# Calculate and store the config file checksum into the app settings
ynh_store_file_checksum "$config"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

ynh_systemctl --service="$app" --action="start" --log_path=systemd --wait_until="Access Pleroma.Web.Endpoint"

#=================================================
# POST INSTALL
#=================================================

# Correct path to 'static dir' in DB
# This must be done when Pleroma is running (i.e. after install and start)
ynh_hide_warnings ynh_exec_as_app -i "$install_dir/live/bin/pleroma_ctl" config migrate_to_db

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
